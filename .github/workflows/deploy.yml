name: Deploy

on:
  pull_request: # enable pull_request for testing
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ====================================================
  # Job 1:  HTML 
  # ====================================================
  deploy-html:
    runs-on: ubuntu-latest
    env:
      GMT_DOC_VERSION: 6.6
    defaults:
      run:
        shell: bash -l {0}
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Micromamba
        uses: mamba-org/setup-micromamba@v2.0.7
        with:
          environment-file: environment.yml
          cache-downloads: false
          cache-environment: true

      - name: Download and list cached files
        continue-on-error: true 
        run: |
          gh run download --name gmt-cache --dir ~/.gmt/ || echo "Cache not found, skipping."
          if [ -d ~/.gmt/server ]; then
            touch ~/.gmt/server/gmt_data_server.txt ~/.gmt/server/gmt_hash_server.txt
            ls -lhR ~/.gmt
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Build HTML
        run: |
          make dirhtml
          cat sphinx_warnings.txt

      - name: Build HTML zip
        run: make htmlzip

      - name: Prepare deployment directory
        run: |
          mkdir -p deploy/${GMT_DOC_VERSION}
          cp -r build/dirhtml/* deploy/${GMT_DOC_VERSION}/
          cp build/GMT_docs.zip deploy/${GMT_DOC_VERSION}/
          echo "docs.gmt-china.org" > deploy/CNAME
          touch deploy/.nojekyll
          
          cd deploy
          rm -rf latest
          ln -sf ${GMT_DOC_VERSION} latest

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: deploy
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

  # ====================================================
  # Job 2:  PDF 
  # ====================================================
  build-pdf:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -l {0}
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Micromamba
        uses: mamba-org/setup-micromamba@v2.0.7
        with:
          environment-file: environment.yml
          cache-downloads: false
          cache-environment: true

      - name: Download and list cached files
        continue-on-error: true 
        run: |
          gh run download --name gmt-cache --dir ~/.gmt/ || echo "Cache not found, skipping."
          if [ -d ~/.gmt/server ]; then
            touch ~/.gmt/server/gmt_data_server.txt ~/.gmt/server/gmt_hash_server.txt
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Install libfuse2 (for AppImage support)
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2

      - name: Setup tectonic
        uses: wtfjoke/setup-tectonic@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache Tectonic packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/Tectonic
          key: ${{ runner.os }}-tectonic-${{ hashFiles('**/*.tex') }}
          restore-keys: |
            ${{ runner.os }}-tectonic-

      - name: Build PDF documentation (Tectonic)
        run: make build_pdf

      - name: Upload PDF to Release
        uses: ncipollo/release-action@v1
        with:
          tag: nightly
          name: "Latest PDF Build"
          allowUpdates: true
          removeArtifacts: true
          replacesArtifacts: true
          makeLatest: true
          artifacts: "build/latex/GMT_docs.pdf"
          token: ${{ secrets.GITHUB_TOKEN }}
